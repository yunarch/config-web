name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      move_tag:
        description: 'Move tag to latest commit if behind'
        type: boolean
        required: false
        default: false

env:
  CI: true
  DO_NOT_TRACK: 1
  HUSKY: 0

permissions:
  contents: write
  id-token: write

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest
    steps:
      - name: üìÅ Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
      - name: üîß Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          registry-url: 'https://registry.npmjs.org'
      - name: üì¶ Install dependencies
        run: bun install --frozen-lockfile
      - name: üîç Lint files
        run: bun run lint
      - name: üî® Build files
        run: bun run build
      - name: üß™ Test distribution
        run: bun run tests
        env:
          TEST_DIST: true
      - name: Verify npm version
        run: bunx npm --version
      - name: üöÄ Publish
        run: bunx npm publish
      - name: üîñ Move tag to latest commit
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.move_tag == 'true'
        run: |
          git config user.name "{{ github.actor }}"
          git config user.email "{{ github.actor }}@users.noreply.github.com"
          VERSION=$(node -p "require('./package.json').version")
          TAG_NAME="v$VERSION"
          HEAD_COMMIT=$(git rev-parse HEAD)

          if git rev-parse "$TAG_NAME" >/dev/null 2>&1; then
            TAG_COMMIT=$(git rev-parse "$TAG_NAME")
            if git merge-base --is-ancestor "$TAG_COMMIT" "$HEAD_COMMIT" && [ "$TAG_COMMIT" != "$HEAD_COMMIT" ]; then
              echo "Tag $TAG_NAME is behind HEAD. Moving from $TAG_COMMIT to $HEAD_COMMIT"
              git tag -d "$TAG_NAME"
              git tag "$TAG_NAME" "$HEAD_COMMIT"
              git push origin "$TAG_NAME" --force
            fi
          fi
      - name: üìù Generate release notes
        run: bunx changelogithub
        env:
          GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}
